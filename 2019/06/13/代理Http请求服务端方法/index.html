<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=7.1.0">








<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  





  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "a32dba06"
    });
  daovoice('update');
  </script>


  <meta name="description" content="系统分两种模式访问1.Debug 模式–&amp;gt;使用数据库连接驱动直连数据库（这个没什么好说）2.代理（Proxy）–&amp;gt;  客户端通过代理（WebRequseter）发送http请求，服务端处理(ApiHandler)接收到Http请求解析处理，返回数据给客户端 ApiHandler 1234567891011121314151617/// &amp;lt;summary&amp;gt;      ///">
<meta name="keywords" content="C#,Http,Proxy,Service">
<meta property="og:type" content="article">
<meta property="og:title" content="代理Http请求服务端方法">
<meta property="og:url" content="http://yoursite.com/2019/06/13/代理Http请求服务端方法/index.html">
<meta property="og:site_name" content="Jam&#39;s blog">
<meta property="og:description" content="系统分两种模式访问1.Debug 模式–&amp;gt;使用数据库连接驱动直连数据库（这个没什么好说）2.代理（Proxy）–&amp;gt;  客户端通过代理（WebRequseter）发送http请求，服务端处理(ApiHandler)接收到Http请求解析处理，返回数据给客户端 ApiHandler 1234567891011121314151617/// &amp;lt;summary&amp;gt;      ///">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-09-26T15:38:47.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="代理Http请求服务端方法">
<meta name="twitter:description" content="系统分两种模式访问1.Debug 模式–&amp;gt;使用数据库连接驱动直连数据库（这个没什么好说）2.代理（Proxy）–&amp;gt;  客户端通过代理（WebRequseter）发送http请求，服务端处理(ApiHandler)接收到Http请求解析处理，返回数据给客户端 ApiHandler 1234567891011121314151617/// &amp;lt;summary&amp;gt;      ///">





  
  
  <link rel="canonical" href="http://yoursite.com/2019/06/13/代理Http请求服务端方法/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>代理Http请求服务端方法 | Jam's blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jam's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">为什么要努力，为了自己吹下的牛逼</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/13/代理Http请求服务端方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jam He">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://hemrj.cn/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jam's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">代理Http请求服务端方法

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-13 09:53:08" itemprop="dateCreated datePublished" datetime="2019-06-13T09:53:08+08:00">2019-06-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-09-26 23:38:47" itemprop="dateModified" datetime="2019-09-26T23:38:47+08:00">2019-09-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Codeing/" itemprop="url" rel="index"><span itemprop="name">Codeing</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="系统分两种模式访问"><a href="#系统分两种模式访问" class="headerlink" title="系统分两种模式访问"></a>系统分两种模式访问</h3><p>1.Debug 模式–&gt;使用数据库连接驱动直连数据库（这个没什么好说）<br>2.代理（Proxy）–&gt;  客户端通过代理（WebRequseter）发送http请求，服务端处理(ApiHandler)接收到Http请求解析处理，返回数据给客户端</p>
<p>ApiHandler</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 通过实现 IHttpHandler 接口的自定义 HttpHandler 启用 HTTP Web 请求的处理。</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="context"&gt;</span>System.Web.HttpContext 对象，它提供对用于为 HTTP </span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 请求提供服务的内部服务器对象（如 Request、Response、Session和 Server）的引用。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessRequest</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line"><span class="function"></span>      &#123;</span><br><span class="line">          <span class="comment">//WebApi分枝。</span></span><br><span class="line">          <span class="keyword">if</span> (context.Request.AppRelativeCurrentExecutionFilePath == <span class="string">"~/Handler.api"</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              ResolveWebApi(context);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (context.Request.AppRelativeCurrentExecutionFilePath == <span class="string">"~/ExternalHandler.api"</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              ResolveWebApiEx(context);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>(ApiHandler)代理模式下无论是His或者行心云都是统一经过了这个入口访问服务端，这里也是他的一个AOP切面，可以在这里添加相关一些统一操作，例如截取所有访问记录日志在这里实现</p>
<h3 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h3><h4 id="主要引用有三个DLL"><a href="#主要引用有三个DLL" class="headerlink" title="主要引用有三个DLL"></a>主要引用有三个DLL</h4><pre><code>1. WebApiResponder
2. WebBridgeContract
3. WebBridgeEndpoint
</code></pre><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><h5 id="路径：-bin-Debug-Config"><a href="#路径：-bin-Debug-Config" class="headerlink" title="路径：~\bin\Debug\Config"></a>路径：~\bin\Debug\Config</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├─Config<span class="selector-class">.ORM</span><span class="selector-class">.xml</span></span><br><span class="line">├─XYHis<span class="selector-class">.FrameWork</span><span class="selector-class">.Services</span><span class="selector-class">.config</span></span><br><span class="line">├─XYHis<span class="selector-class">.IBusiness</span><span class="selector-class">.GblSystem</span><span class="selector-class">.config</span></span><br><span class="line">├─XYHis<span class="selector-class">.IService</span><span class="selector-class">.config</span>               --以此为例</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TypeMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MapKey</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">InterfaceName</span>&gt;</span>XYHis.IService.IPatientService.IBed<span class="tag">&lt;/<span class="name">InterfaceName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MapToType</span>&gt;</span>XYHis.Service.PatientService.Bed,XYHis.Service<span class="tag">&lt;/<span class="name">MapToType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">CreaterMethod</span>&gt;</span><span class="tag">&lt;/<span class="name">CreaterMethod</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LifeTimeCode</span>&gt;</span>Transient<span class="tag">&lt;/<span class="name">LifeTimeCode</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WebApiUrlList</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">string</span>&gt;</span>http://120.77.3.221:8097/Handler.api<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">WebApiUrlList</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">TypeMap</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Web-Config"><a href="#Web-Config" class="headerlink" title="Web.Config"></a>Web.Config</h4><h5 id="Web-config-文件中的-system-webServer-节用于指定适用于-Web-应用程序的-IIS-7-0-设置"><a href="#Web-config-文件中的-system-webServer-节用于指定适用于-Web-应用程序的-IIS-7-0-设置" class="headerlink" title="Web.config 文件中的 system.webServer 节用于指定适用于 Web 应用程序的 IIS 7.0 设置"></a>Web.config 文件中的 system.webServer 节用于指定适用于 Web 应用程序的 IIS 7.0 设置</h5><h5 id="system-WebServer-是-configuration节的子级"><a href="#system-WebServer-是-configuration节的子级" class="headerlink" title="system.WebServer 是 configuration节的子级"></a>system.WebServer 是 <a href="https://technet.microsoft.com/zh-cn/sysinternals/ms228147" target="_blank" rel="noopener">configuration</a>节的子级</h5><h5 id="只适用于-IIS-7-0-集成模式，而不适用于经典模式"><a href="#只适用于-IIS-7-0-集成模式，而不适用于经典模式" class="headerlink" title="只适用于 IIS 7.0 集成模式，而不适用于经典模式"></a>只适用于 IIS 7.0 集成模式，而不适用于经典模式</h5><ul>
<li><p>当请求未包含特定资源时，Web 服务器返回给客户端的默认文档（defaultDocument 元素）。</p>
</li>
<li><p>响应的压缩设置（httpCompression 元素）。</p>
</li>
<li><p>自定义标头（httpProtocol 节的 customHeaders 元素）。</p>
</li>
<li><p>模块（modules 元素）。</p>
</li>
<li><p>处理程序（handlers 元素）</p>
</li>
</ul>
<h5 id="如果应用程序正在经典模式下运行，则会忽略-Web-config-文件的-system-WebServer-节中指定的所有托管代码模块和处理程序。与-IIS-的早期版本相同，托管代码模块和处理程序必须在-system-web-节的-httpModules-和-httpHandlers-元素中定义。"><a href="#如果应用程序正在经典模式下运行，则会忽略-Web-config-文件的-system-WebServer-节中指定的所有托管代码模块和处理程序。与-IIS-的早期版本相同，托管代码模块和处理程序必须在-system-web-节的-httpModules-和-httpHandlers-元素中定义。" class="headerlink" title="如果应用程序正在经典模式下运行，则会忽略 Web.config 文件的 system.WebServer 节中指定的所有托管代码模块和处理程序。与 IIS 的早期版本相同，托管代码模块和处理程序必须在 system.web 节的 httpModules 和 httpHandlers 元素中定义。"></a>如果应用程序正在经典模式下运行，则会忽略 Web.config 文件的 system.WebServer 节中指定的所有托管代码模块和处理程序。与 IIS 的早期版本相同，托管代码模块和处理程序必须在 system.web 节的 httpModules 和 httpHandlers 元素中定义。</h5><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;handlers&gt;</span><br><span class="line">      &lt;remove name=<span class="string">"ExtensionlessUrlHandler-Integrated-4.0"</span>/&gt;</span><br><span class="line">      &lt;remove name=<span class="string">"OPTIONSVerbHandler"</span>/&gt;</span><br><span class="line">      &lt;remove name=<span class="string">"TRACEVerbHandler"</span>/&gt;</span><br><span class="line">      &lt;add name=<span class="string">"ExtensionlessUrlHandler-Integrated-4.0"</span> path=<span class="string">"*."</span> verb=<span class="string">"*"</span> type=<span class="string">"System.Web.Handlers.TransferRequestHandler"</span> preCondition=<span class="string">"integratedMode,runtimeVersionv4.0"</span>/&gt;</span><br><span class="line">      &lt;add name=<span class="string">"ApiHandle"</span> verb=<span class="string">"*"</span> path=<span class="string">"*.api"</span> type=<span class="string">"WebApiResponder.ApiHandler,WebApiResponder"</span>/&gt;</span><br><span class="line">    &lt;/handlers&gt;</span><br></pre></td></tr></table></figure>
<h4 id="Web-Config-Demo"><a href="#Web-Config-Demo" class="headerlink" title="Web.Config Demo"></a>Web.Config Demo</h4><ul>
<li>访问地址  <a href="http://localhost:6166/WebSite1/api/request.aspx?strtext=123" target="_blank" rel="noopener">http://localhost:6166/WebSite1/api/request.aspx?strtext=123</a></li>
<li>配置文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--IIS经典模式下使用--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">system.web</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">httpHandlers</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">add</span> <span class="attr">path</span>=<span class="string">"request.aspx"</span> <span class="attr">verb</span>=<span class="string">"*"</span> <span class="attr">type</span>=<span class="string">" Bll.Handler.Test"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">add</span> <span class="attr">path</span>=<span class="string">"test.aspx"</span> <span class="attr">verb</span>=<span class="string">"*"</span> <span class="attr">type</span>=<span class="string">" Bll.Handler.Test"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">httpHandlers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">system.web</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--IIS集成模式下使用--&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--&lt;system.webServer&gt;</span></span><br><span class="line"><span class="comment">    &lt;handlers&gt;</span></span><br><span class="line"><span class="comment">      &lt;add name="request" path="request.aspx" verb="*" type=" Bll.Handler.Test"/&gt;</span></span><br><span class="line"><span class="comment">      &lt;add name="test" path="test.aspx" verb="*" type=" Bll.Handler.Test"/&gt;</span></span><br><span class="line"><span class="comment">    &lt;/handlers&gt;</span></span><br><span class="line"><span class="comment">  &lt;/system.webServer&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="builtin-name">add</span> <span class="attribute">path</span>=<span class="string">"request.aspx"</span> <span class="attribute">verb</span>=<span class="string">"*"</span> <span class="attribute">type</span>=<span class="string">" Bll.Handler.Test"</span>/&gt;</span><br><span class="line"></span><br><span class="line">path这个呢就是我们访问的网页地址，就是上面输入的，我们找不到的那个文件名</span><br><span class="line">然后对应的处理程序是<span class="attribute">type</span>=<span class="string">" Bll.Handler.Test"</span></span><br><span class="line"><span class="attribute">verb</span>=<span class="string">"*"</span> 是指定接收的方式，*是Get，Post都可以，也可以直接写Post这样就只接收Post提交了。</span><br><span class="line">现在大家明白了吧</span><br><span class="line">你访问request.aspx其实访问的就是Bll.Handler.Test.cs</span><br><span class="line"></span><br><span class="line">&lt;<span class="builtin-name">add</span> <span class="attribute">name</span>=<span class="string">"ApiHandle"</span> <span class="attribute">verb</span>=<span class="string">"*"</span> <span class="attribute">path</span>=<span class="string">"*.api"</span> <span class="attribute">type</span>=<span class="string">"WebApiResponder.ApiHandler,WebApiResponder"</span>/&gt;</span><br><span class="line">那么我们的配置文件中的，同理可得</span><br><span class="line"><span class="attribute">verb</span>=<span class="string">"*"</span>   所有的请求模式都可以</span><br><span class="line"><span class="attribute">path</span>=<span class="string">"*.api"</span>  截取访问地址为.api后缀的请求</span><br><span class="line">对应的处理程序是<span class="attribute">type</span>=<span class="string">"WebApiResponder.ApiHandler,WebApiResponder"</span></span><br><span class="line">WebApiResponder目录下的ApiHandler，类库为 WebApiResponder</span><br></pre></td></tr></table></figure>
<h4 id="ApiHandler"><a href="#ApiHandler" class="headerlink" title="ApiHandler"></a>ApiHandler</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Orm.WebBridgeContract;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Orm.WebApiResponder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ApiHandler</span> : <span class="title">IHttpHandler</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> json序列化器。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        IJsonSerializer Serializer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 构造函数。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ApiHandler</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Serializer = ServiceTaker.GetService&lt;IJsonSerializer&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取一个值，该值指示其他请求是否可以使用 IHttpHandler 实例。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 如果 IHttpHandler 实例可再次使用，则为 true；否则为 false。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">bool</span> IsReusable</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通过实现 IHttpHandler 接口的自定义 HttpHandler 启用 HTTP Web 请求的处理。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="context"&gt;</span>System.Web.HttpContext 对象，它提供对用于为 HTTP </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 请求提供服务的内部服务器对象（如 Request、Response、Session和 Server）的引用。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ProcessRequest</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//WebApi分枝。</span></span><br><span class="line">            <span class="keyword">if</span> (context.Request.AppRelativeCurrentExecutionFilePath == <span class="string">"~/Handler.api"</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ResolveWebApi(context);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (context.Request.AppRelativeCurrentExecutionFilePath == <span class="string">"~/ExternalHandler.api"</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ResolveWebApiEx(context);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 解析WebApi的请求。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="context"&gt;</span>http上下文<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ResolveWebApi</span>(<span class="params">HttpContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> watch = <span class="keyword">new</span> System.Diagnostics.Stopwatch();</span><br><span class="line">            watch.Start();</span><br><span class="line">            Stream streamResponse = context.Request.InputStream;</span><br><span class="line">            StreamReader streamRead = <span class="keyword">new</span> StreamReader(streamResponse, Encoding.UTF8);</span><br><span class="line">            <span class="keyword">string</span> strResponse = streamRead.ReadToEnd();</span><br><span class="line">            streamResponse.Close();</span><br><span class="line">            streamRead.Close();</span><br><span class="line">            MethodDC theContract = <span class="keyword">new</span> MethodDC();</span><br><span class="line">            ApiResultDC theResult = <span class="keyword">new</span> ApiResultDC();</span><br><span class="line">            InvokeResult result = <span class="keyword">new</span> InvokeResult();</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                theContract = Serializer.Deserialize&lt;MethodDC&gt;(strResponse);</span><br><span class="line">                ApiCore apiCpre = <span class="keyword">new</span> ApiCore(theContract);</span><br><span class="line">                result = apiCpre.Invoke();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (result.ResultType.Name.ToLower() != <span class="string">"void"</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    theResult.JsonValue = Serializer.Serialize(result.ResultValue);</span><br><span class="line">                    theResult.TypeQualifiedName = result.ResultType.AssemblyQualifiedName;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    theResult.JsonValue = <span class="keyword">string</span>.Empty;</span><br><span class="line">                    theResult.TypeQualifiedName = result.ResultType.AssemblyQualifiedName;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (ex.InnerException != <span class="literal">null</span> &amp;&amp; ex.InnerException <span class="keyword">is</span> Orm.Utilities.InformationException)</span><br><span class="line">                &#123;</span><br><span class="line">                    theResult.HasException = <span class="literal">true</span>;</span><br><span class="line">                    theResult.ExceptionMessage = ex.InnerException.Message;</span><br><span class="line">                    theResult.ExceptionState = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ex.InnerException <span class="keyword">is</span> Orm.Utilities.WarningException)</span><br><span class="line">                &#123;</span><br><span class="line">                    theResult.HasException = <span class="literal">true</span>;</span><br><span class="line">                    theResult.ExceptionMessage = ex.InnerException.Message;</span><br><span class="line">                    theResult.ExceptionState = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ex.InnerException <span class="keyword">is</span> Orm.Utilities.ErrorException)</span><br><span class="line">                &#123;</span><br><span class="line">                    theResult.HasException = <span class="literal">true</span>;</span><br><span class="line">                    theResult.ExceptionMessage = ex.InnerException.Message;</span><br><span class="line">                    theResult.ExceptionState = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    theResult.HasException = <span class="literal">true</span>;</span><br><span class="line">                    theResult.ExceptionMessage = ex.InnerException == <span class="literal">null</span> ? ex.Message : ex.InnerException.Message;</span><br><span class="line">                    theResult.ExceptionStack = ex.InnerException == <span class="literal">null</span> ? ex.StackTrace : ex.InnerException.StackTrace;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//Orm.Framework.Services.AppLogger.Log(ex.InnerException == null ? ex.Message : ex.InnerException.Message + "\r\n" + ex.StackTrace);</span></span><br><span class="line">                StringBuilder errLog = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">if</span> (strResponse.Length &gt; <span class="number">500</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    errLog.Append(strResponse.Substring(<span class="number">0</span>, <span class="number">500</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    errLog.Append(strResponse);</span><br><span class="line">                &#125;</span><br><span class="line">                Orm.Framework.Services.AppLogger.Log(ex.InnerException == <span class="literal">null</span> ? <span class="string">"\r\n\r\n"</span> + ex.Message + <span class="string">"\r\n\r\n"</span> + ex.StackTrace + <span class="string">"\r\n\r\n"</span> + errLog.ToString() : <span class="string">"\r\n\r\n"</span> + ex.InnerException.Message + <span class="string">"\r\n\r\n"</span> + ex.InnerException.StackTrace + <span class="string">"\r\n\r\n"</span> + errLog.ToString());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            theContract.Result = theResult;</span><br><span class="line">            <span class="keyword">string</span> jsonResult = Serializer.Serialize(theContract);</span><br><span class="line">            context.Response.Write(jsonResult);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果返回的数据大点则采用GZip压缩。</span></span><br><span class="line">            <span class="keyword">if</span> (jsonResult.Length &gt; <span class="number">10000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//向输出流头部添加压缩信息</span></span><br><span class="line">                context.Response.AppendHeader(<span class="string">"Content-encoding"</span>, <span class="string">"gzip"</span>);</span><br><span class="line">                context.Response.Filter = <span class="keyword">new</span> GZipStream(context.Response.Filter, CompressionMode.Compress);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            watch.Stop();</span><br><span class="line">            <span class="comment">//访问日志记录</span></span><br><span class="line">            <span class="comment">//Task.Factory.StartNew(() =&gt; &#123;</span></span><br><span class="line">                <span class="keyword">string</span> Parameters = <span class="string">""</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; theContract.ParameterList.Count; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="keyword">var</span> ss = theContract.ParameterList[i].JsonValue.Length;</span><br><span class="line">                    Parameters += theContract.ParameterList[i].JsonValue.Replace(<span class="string">"\""</span>,<span class="string">""</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">string</span> strCookies = context.Request.Cookies.Keys[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">string</span>[] strCookiesArray = strCookies.Split(<span class="string">'@'</span>);</span><br><span class="line">                <span class="comment">//AOP截取服务方法访问，记录日志</span></span><br><span class="line">                CountUserData countUserData = <span class="keyword">new</span> CountUserData</span><br><span class="line">                &#123;</span><br><span class="line">                    ApiInterfaceName = theContract.InterfaceName,</span><br><span class="line">                    ClientComputerIP = context.Request.UserHostAddress,</span><br><span class="line">                    LanIp = strCookiesArray[<span class="number">2</span>],</span><br><span class="line">                    UserName = strCookiesArray[<span class="number">1</span>],</span><br><span class="line">                    LocationName = strCookiesArray[<span class="number">0</span>],</span><br><span class="line">                    MethodName = theContract.MethodName,</span><br><span class="line">                    ResponseData = Encoding.Default.GetByteCount(jsonResult).ToString(),</span><br><span class="line">                    OperTime = context.Timestamp,</span><br><span class="line">                    ParameterContents = Parameters,</span><br><span class="line">                    CounterTime = watch.ElapsedMilliseconds,</span><br><span class="line">                &#125;;</span><br><span class="line">                JavaScriptSerializer jsSerializer = <span class="keyword">new</span> JavaScriptSerializer();</span><br><span class="line">                System.Text.StringBuilder data_mainJson = <span class="keyword">new</span> System.Text.StringBuilder();</span><br><span class="line">                jsSerializer.Serialize(countUserData, data_mainJson);</span><br><span class="line">                <span class="keyword">string</span> strRequestLog = <span class="keyword">string</span>.Format(<span class="string">"Url：&#123;0&#125; "</span>, data_mainJson);</span><br><span class="line">                Orm.Framework.Services.AppLogger.Log(strRequestLog, <span class="string">@"E:\PerformanceLog\"</span> + DateTime.Now.ToString(<span class="string">"yyyyMMdd"</span>), AppDomain.CurrentDomain.Id.ToString() + <span class="string">".log"</span>);</span><br><span class="line">           <span class="comment"><span class="doctag">///</span> &#125;);</span></span><br><span class="line">            <span class="comment">//写请求日志，用于跟踪请求的时间和数据大小。</span></span><br><span class="line">            <span class="keyword">if</span> (watch.ElapsedMilliseconds &gt; <span class="number">2000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                StringBuilder errLog = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">if</span> (strResponse.Length &gt; <span class="number">500</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    errLog.Append(strResponse.Substring(<span class="number">0</span>, <span class="number">500</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    errLog.Append(strResponse);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">string</span> strRequestTimeLog = <span class="keyword">string</span>.Format(<span class="string">"Url：&#123;0&#125; 大于2秒：&#123;1&#125; JSON:&#123;2&#125;"</span>, context.Request.Url.ToString(), watch.ElapsedMilliseconds.ToString(), errLog);</span><br><span class="line">                <span class="comment">//  Orm.Framework.Services.AppLogger.Log(strRequestTimeLog, @"D:\PerformanceLog\" + DateTime.Now.ToString("yyyyMMdd"), AppDomain.CurrentDomain.Id.ToString() + ".log");</span></span><br><span class="line">                strRequestTimeLog = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果是大对象85000的10倍</span></span><br><span class="line">            <span class="keyword">if</span> (System.Text.Encoding.Default.GetByteCount(jsonResult) &gt; <span class="number">840000</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                StringBuilder errLog = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                <span class="keyword">if</span> (strResponse.Length &gt; <span class="number">500</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    errLog.Append(strResponse.Substring(<span class="number">0</span>, <span class="number">500</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    errLog.Append(strResponse);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//向输出流头部添加压缩信息</span></span><br><span class="line">                <span class="comment">// Orm.Framework.Services.AppLogger.Log(string.Format("Url：&#123;0&#125; 大于850K的对象：&#123;1&#125;", context.Request.Url.ToString(), errLog), @"D:\PerformanceLog\" + DateTime.Now.ToString("yyyyMMdd"), AppDomain.CurrentDomain.Id.ToString() + ".log");</span></span><br><span class="line">            &#125;</span><br><span class="line">            jsonResult = <span class="literal">null</span>;</span><br><span class="line">            strResponse = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="WebBridgeEndpoint"><a href="#WebBridgeEndpoint" class="headerlink" title="WebBridgeEndpoint"></a>WebBridgeEndpoint</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Orm.WebBridgeEndpoint</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WebRequseter</span></span><br><span class="line">    &#123;</span><br><span class="line">        IJsonSerializer Serializer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WebRequseter</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Serializer = ServiceTaker.GetService&lt;IJsonSerializer&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">object</span> <span class="title">RequseteWeb</span>(<span class="params"><span class="keyword">string</span> apiMapKey, <span class="keyword">string</span> apiInterfaceName, <span class="keyword">string</span> methodName, List&lt;<span class="keyword">object</span>&gt; parameterList, <span class="keyword">string</span> apiUrl = <span class="string">""</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> RequseteWeb(apiMapKey, apiInterfaceName, methodName, parameterList, <span class="literal">null</span>, apiUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">object</span> <span class="title">RequseteWeb</span>(<span class="params"><span class="keyword">string</span> apiMapKey, <span class="keyword">string</span> apiInterfaceName, <span class="keyword">string</span> methodName, List&lt;<span class="keyword">object</span>&gt; parameterList, <span class="keyword">string</span>[] types, <span class="keyword">string</span> apiUrl = <span class="string">""</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            HttpWebResponse response = <span class="literal">null</span>;</span><br><span class="line">            Stream streamResponse = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">string</span> cookieStr = UserProfiles.HospitalID + <span class="string">"@"</span> + UserProfiles.UserID +<span class="string">"@"</span> + UserProfiles.ClientComputerGuid;</span><br><span class="line">                MethodDC theContract = <span class="keyword">new</span> MethodDC();</span><br><span class="line">                theContract.ApiConfigKey = apiMapKey;</span><br><span class="line">                theContract.InterfaceName = apiInterfaceName;</span><br><span class="line">                theContract.MethodName = methodName;</span><br><span class="line">                theContract.TypeArguments = types;</span><br><span class="line">                List&lt;ParameterDC&gt; webParamerList = <span class="keyword">new</span> List&lt;ParameterDC&gt;();</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">object</span> param <span class="keyword">in</span> parameterList)</span><br><span class="line">                &#123;</span><br><span class="line">                    ParameterDC aWebParamer = <span class="keyword">new</span> ParameterDC();</span><br><span class="line">                    aWebParamer.TypeQualifiedName = param.GetType().AssemblyQualifiedName;</span><br><span class="line">                    aWebParamer.JsonValue = Serializer.Serialize(param);</span><br><span class="line">                    webParamerList.Add(aWebParamer);</span><br><span class="line">                &#125;</span><br><span class="line">                theContract.ParameterList = webParamerList;</span><br><span class="line">                <span class="keyword">string</span> jsonContract = Serializer.Serialize(theContract);</span><br><span class="line">                <span class="comment">//<span class="doctag">TODO:</span>加密或压缩对jsonContract,密文可根据日期变化。服务端验证密文 </span></span><br><span class="line">                MethodDC vdf = Serializer.Deserialize&lt;MethodDC&gt;(jsonContract);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">byte</span>[] PostData = Encoding.UTF8.GetBytes(jsonContract);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> watch = <span class="keyword">new</span> System.Diagnostics.Stopwatch();</span><br><span class="line">                watch.Start();</span><br><span class="line">                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(apiUrl);</span><br><span class="line">                request.Method = <span class="string">"POST"</span>;</span><br><span class="line">                request.ContentType = <span class="string">"application/x-www-form-urlencoded"</span>;</span><br><span class="line">                request.GetRequestStream().Write(PostData, <span class="number">0</span>, PostData.Length);</span><br><span class="line">                request.ContentType = <span class="string">"text/xml"</span>;</span><br><span class="line">                request.Headers.Add(<span class="string">"Cookie"</span>, cookieStr);</span><br><span class="line">                ServicePoint currentServicePoint = request.ServicePoint;</span><br><span class="line">                currentServicePoint.ConnectionLimit = <span class="number">1000</span>;</span><br><span class="line">                response = (HttpWebResponse)request.GetResponse();</span><br><span class="line"></span><br><span class="line">                streamResponse = response.GetResponseStream();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">string</span> strResponse = <span class="keyword">string</span>.Empty;</span><br><span class="line">                <span class="comment">//如果服务端采用了GZIP压缩,则先解压缩。</span></span><br><span class="line">                <span class="keyword">if</span> (response.ContentEncoding.ToLower().Contains(<span class="string">"gzip"</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (GZipStream gz = <span class="keyword">new</span> GZipStream(streamResponse, CompressionMode.Decompress))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">using</span> (StreamReader readerGzip = <span class="keyword">new</span> StreamReader(gz, Encoding.UTF8))</span><br><span class="line">                        &#123;</span><br><span class="line">                            strResponse = readerGzip.ReadToEnd();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">using</span> (StreamReader streamRead = <span class="keyword">new</span> StreamReader(streamResponse, Encoding.UTF8))</span><br><span class="line">                    &#123;</span><br><span class="line">                        strResponse = streamRead.ReadToEnd();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//<span class="doctag">TODO:</span>解密或解压缩对strResponse</span></span><br><span class="line">                MethodDC reObj = Serializer.Deserialize&lt;MethodDC&gt;(strResponse);</span><br><span class="line">                watch.Stop();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//写请求日志，用于跟踪请求的时间和数据大小。</span></span><br><span class="line">                <span class="keyword">string</span> writeWebRequestLog = System.Configuration.ConfigurationManager.AppSettings[<span class="string">"WriteClientHttpWebRequestLog"</span>];</span><br><span class="line">                <span class="keyword">if</span> (writeWebRequestLog == <span class="literal">null</span>) &#123; writeWebRequestLog = <span class="string">"false"</span>; &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">bool</span>.Parse(writeWebRequestLog) &amp;&amp; !apiInterfaceName.Contains(<span class="string">"DBClientBase"</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    Task task = Task.Factory.StartNew(() =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">byte</span>[] responseData = Encoding.UTF8.GetBytes(strResponse);</span><br><span class="line">                        <span class="keyword">var</span> counter = watch.ElapsedMilliseconds;</span><br><span class="line">                        <span class="keyword">string</span> Parameters = <span class="string">""</span>;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; theContract.ParameterList.Count; i++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Parameters += theContract.ParameterList[i].JsonValue + <span class="string">"@"</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        CountUserData countUserData = <span class="keyword">new</span> CountUserData</span><br><span class="line">                        &#123;</span><br><span class="line">                            ApiInterfaceName = apiInterfaceName,</span><br><span class="line">                            ClientComputerIP = UserProfiles.ClientComputerGuid,</span><br><span class="line">                            UserName = UserProfiles.UserID,</span><br><span class="line">                            LocationName = UserProfiles.HospitalID.ToString (),</span><br><span class="line">                            MethodName = methodName,</span><br><span class="line">                            CounterTime = counter,</span><br><span class="line">                            ResponseData = (responseData.Length / <span class="number">1024.00</span>).ToString(<span class="string">"f0"</span>),</span><br><span class="line">                            OperTime = DateTime.Now,</span><br><span class="line">                            ParameterContents = Parameters,</span><br><span class="line">                        &#125;;</span><br><span class="line">                        <span class="comment">//Orm.Config.Service.DBClientService.Add&lt;CountUserData&gt;(countUserData);</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="comment">//string strRequestTimeLog = string.Format(" 诊所：&#123;0&#125; ip地址：&#123;1&#125;  操作人：&#123;2&#125; 操作时间：&#123;3&#125; 接口：&#123;4&#125;调用方法：&#123;5&#125; 请求响应时间：&#123;6&#125;(毫秒) 返回值大小：&#123;7&#125;Kb", </span></span><br><span class="line">                    <span class="comment">//    UserProfiles.LocationName, UserProfiles.ClientComputerGuid,UserProfiles.UserName,DateTime.Now, apiInterfaceName, methodName, counter.ToString(), (responseData.Length / 1024.00).ToString("f0"));</span></span><br><span class="line">                    <span class="comment">//WriteLog(strRequestTimeLog, null);</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (reObj.Result.HasException)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (reObj.Result.ExceptionState == <span class="number">1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        System.Windows.Forms.MessageBox.Show(reObj.Result.ExceptionMessage, <span class="string">"消息"</span>, System.Windows.Forms.MessageBoxButtons.OK, System.Windows.Forms.MessageBoxIcon.Information);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (reObj.Result.ExceptionState == <span class="number">2</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        System.Windows.Forms.MessageBox.Show(reObj.Result.ExceptionMessage, <span class="string">"警告"</span>, System.Windows.Forms.MessageBoxButtons.OK, System.Windows.Forms.MessageBoxIcon.Warning);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (reObj.Result.ExceptionState == <span class="number">3</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        System.Windows.Forms.MessageBox.Show(reObj.Result.ExceptionMessage, <span class="string">"错误"</span>, System.Windows.Forms.MessageBoxButtons.OK, System.Windows.Forms.MessageBoxIcon.Error);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Message: "</span> + reObj.Result.ExceptionMessage + <span class="string">"\r\n"</span></span><br><span class="line">                            + <span class="string">"Stack: "</span> + reObj.Result.ExceptionStack);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Type relType = Type.GetType(reObj.Result.TypeQualifiedName);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">object</span> relResult = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (relType.Name.ToLower() != <span class="string">"void"</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        relResult = Serializer.Deserialize(reObj.Result.JsonValue, relType);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> relResult;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (streamResponse != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    streamResponse.Close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (response != <span class="literal">null</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    response.Close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="XYHis-Config-Service-cs"><a href="#XYHis-Config-Service-cs" class="headerlink" title="XYHis.Config.Service.cs"></a>XYHis.Config.Service.cs</h4><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全局服务类访问</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ITestDemoServices _TestDemoServices;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> ITestDemoServices TestDemoServices</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">get</span></span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">if</span> (_TestDemoServices == <span class="literal">null</span>)</span><br><span class="line">              &#123;</span><br><span class="line">                  _TestDemoServices = ServiceTaker.GetRemoteService&lt;ITestDemoServices&gt;();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> _TestDemoServices;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h4 id="XYHis-Framework-Services-ServiceTaker-cs"><a href="#XYHis-Framework-Services-ServiceTaker-cs" class="headerlink" title="XYHis.Framework.Services.ServiceTaker.cs"></a>XYHis.Framework.Services.ServiceTaker.cs</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> 取任意已经提供的Web服务。客户端使用</span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name="T"&gt;</span>服务类型。<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name="MapKey"&gt;</span>服务标识。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">      <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">static</span> T GetRemoteService&lt;T&gt;(<span class="keyword">string</span> MapKey = <span class="string">""</span>) <span class="keyword">where</span> T : <span class="keyword">class</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">if</span> (AppSettings.Debug)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> GetService&lt;T&gt;(MapKey);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">var</span> theMaped = MapContainer.GetTypeMap(MapKey, <span class="keyword">typeof</span>(T).FullName);</span><br><span class="line">          <span class="keyword">if</span> (theMaped == <span class="literal">null</span>)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="keyword">typeof</span>(T).FullName + <span class="string">" 没有在配置文件中注册映射。"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">var</span> Manager = GetService&lt;IRemoteProxyManager&gt;();</span><br><span class="line">          T proxy = Manager.GetApiProxy&lt;T&gt;(theMaped);</span><br><span class="line">          <span class="keyword">return</span> proxy;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h4 id="bin-Debug-Config"><a href="#bin-Debug-Config" class="headerlink" title="~\bin\Debug\Config"></a>~\bin\Debug\Config</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TypeMap</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">MapKey</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">InterfaceName</span>&gt;</span>Orm.IServices.ITestSercive.ITestDemoServices<span class="tag">&lt;/<span class="name">InterfaceName</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">MapToType</span>&gt;</span>Orm.Services.TestSercive.TestDemoServices,Orm.Services.TestSercive<span class="tag">&lt;/<span class="name">MapToType</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">CreaterMethod</span>&gt;</span><span class="tag">&lt;/<span class="name">CreaterMethod</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">LifeTimeCode</span>&gt;</span>Transient<span class="tag">&lt;/<span class="name">LifeTimeCode</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">WebApiUrlList</span>&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">string</span>&gt;</span>http://127.0.0.1:8088/Handler.api<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">WebApiUrlList</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">TypeMap</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Proxy-XYHis-IServices-TestSercive"><a href="#Proxy-XYHis-IServices-TestSercive" class="headerlink" title="Proxy_XYHis.IServices.TestSercive"></a>Proxy_XYHis.IServices.TestSercive</h4><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BsHospital&gt; <span class="title">GetLocHouseRoomName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>      &#123;</span><br><span class="line">          List&lt;Object&gt; ParamList = <span class="keyword">new</span> List&lt;Object&gt;();</span><br><span class="line">          <span class="keyword">string</span>[] TypeArgs = <span class="literal">null</span>;</span><br><span class="line">          <span class="keyword">return</span> (List&lt;BsHospital&gt;)TheReQuseter.RequseteWeb(ApiTypeMap.MapConfigKey, <span class="string">"Orm.IServices.ITestSercive.ITestDemoServices"</span>, <span class="string">"GetLocHouseRoomName"</span>, ParamList, TypeArgs, GetOneUrl());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//GetOneUrl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetOneUrl</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>      &#123;</span><br><span class="line">          Random rd = <span class="keyword">new</span> Random();</span><br><span class="line">          <span class="keyword">int</span> id = rd.Next(<span class="number">0</span>, ApiTypeMap.WebApiUrlList.Count);</span><br><span class="line">          <span class="comment">//return ApiTypeMap.WebApiUrlList[id];</span></span><br><span class="line">          <span class="keyword">if</span> (Environments.IISServerUrl != <span class="keyword">string</span>.Empty)</span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> Environments.IISServerUrl;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">              <span class="keyword">return</span> ConfigurationManager.AppSettings[<span class="string">"ServiceAddress"</span>];</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutoUpdater</span></span><br><span class="line">&#123; </span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span>检查更新</span></span><br><span class="line">	<span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CheckUpdate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="keyword">string</span> serverUrl = ConfigurationManager.AppSettings[<span class="string">"ServiceAddress"</span>];</span><br><span class="line">		<span class="keyword">string</span> updateUrl = ConfigurationManager.AppSettings[<span class="string">"UpdateAddress"</span>];</span><br><span class="line">		XYHis.Framework.Services.Environments.IISServerUrl = serverUrl;</span><br><span class="line">		.....</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ApiHandler-前面有介绍"><a href="#ApiHandler-前面有介绍" class="headerlink" title="ApiHandler  前面有介绍"></a>ApiHandler  前面有介绍</h4><h4 id="XYHis-Services-TestSercive"><a href="#XYHis-Services-TestSercive" class="headerlink" title="XYHis.Services.TestSercive"></a>XYHis.Services.TestSercive</h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">List</span>&lt;BsHospital&gt; GetLocHouseRoomName()</span><br><span class="line">      &#123;</span><br><span class="line">	XXX<span class="params">...</span><span class="params">...</span></span><br><span class="line">	<span class="params">...</span><span class="params">...</span><span class="params">...</span></span><br><span class="line">	<span class="params">...</span><span class="params">...</span><span class="params">...</span></span><br><span class="line">          <span class="keyword">return</span> ;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    
      
    
    

    

	<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
  
</div>
	
    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C#</a>
          
            <a href="/tags/Http/" rel="tag"><i class="fa fa-tag"></i> Http</a>
          
            <a href="/tags/Proxy/" rel="tag"><i class="fa fa-tag"></i> Proxy</a>
          
            <a href="/tags/Service/" rel="tag"><i class="fa fa-tag"></i> Service</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/12/C-自定义Distinct扩展方法/" rel="next" title="C#自定义Distinct扩展方法">
                <i class="fa fa-chevron-left"></i> C#自定义Distinct扩展方法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/13/Git常用命令操作/" rel="prev" title="Git常用命令操作">
                Git常用命令操作 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://hemrj.cn/avatar.jpg" alt="Jam He">
            
              <p class="site-author-name" itemprop="name">Jam He</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#系统分两种模式访问"><span class="nav-number">1.</span> <span class="nav-text">系统分两种模式访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代理模式"><span class="nav-number">2.</span> <span class="nav-text">代理模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主要引用有三个DLL"><span class="nav-number">2.1.</span> <span class="nav-text">主要引用有三个DLL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置文件"><span class="nav-number">2.2.</span> <span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#路径：-bin-Debug-Config"><span class="nav-number">2.2.1.</span> <span class="nav-text">路径：~\bin\Debug\Config</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Web-Config"><span class="nav-number">2.3.</span> <span class="nav-text">Web.Config</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Web-config-文件中的-system-webServer-节用于指定适用于-Web-应用程序的-IIS-7-0-设置"><span class="nav-number">2.3.1.</span> <span class="nav-text">Web.config 文件中的 system.webServer 节用于指定适用于 Web 应用程序的 IIS 7.0 设置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#system-WebServer-是-configuration节的子级"><span class="nav-number">2.3.2.</span> <span class="nav-text">system.WebServer 是 configuration节的子级</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#只适用于-IIS-7-0-集成模式，而不适用于经典模式"><span class="nav-number">2.3.3.</span> <span class="nav-text">只适用于 IIS 7.0 集成模式，而不适用于经典模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如果应用程序正在经典模式下运行，则会忽略-Web-config-文件的-system-WebServer-节中指定的所有托管代码模块和处理程序。与-IIS-的早期版本相同，托管代码模块和处理程序必须在-system-web-节的-httpModules-和-httpHandlers-元素中定义。"><span class="nav-number">2.3.4.</span> <span class="nav-text">如果应用程序正在经典模式下运行，则会忽略 Web.config 文件的 system.WebServer 节中指定的所有托管代码模块和处理程序。与 IIS 的早期版本相同，托管代码模块和处理程序必须在 system.web 节的 httpModules 和 httpHandlers 元素中定义。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Web-Config-Demo"><span class="nav-number">2.4.</span> <span class="nav-text">Web.Config Demo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ApiHandler"><span class="nav-number">2.5.</span> <span class="nav-text">ApiHandler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WebBridgeEndpoint"><span class="nav-number">2.6.</span> <span class="nav-text">WebBridgeEndpoint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XYHis-Config-Service-cs"><span class="nav-number">2.7.</span> <span class="nav-text">XYHis.Config.Service.cs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XYHis-Framework-Services-ServiceTaker-cs"><span class="nav-number">2.8.</span> <span class="nav-text">XYHis.Framework.Services.ServiceTaker.cs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bin-Debug-Config"><span class="nav-number">2.9.</span> <span class="nav-text">~\bin\Debug\Config</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Proxy-XYHis-IServices-TestSercive"><span class="nav-number">2.10.</span> <span class="nav-text">Proxy_XYHis.IServices.TestSercive</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ApiHandler-前面有介绍"><span class="nav-number">2.11.</span> <span class="nav-text">ApiHandler  前面有介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XYHis-Services-TestSercive"><span class="nav-number">2.12.</span> <span class="nav-text">XYHis.Services.TestSercive</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-"></i>
  </span>
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <span class="author" itemprop="copyrightHolder">Jam He</span>
  
	<div class="powered-by">
	<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
	  本站访客数:<span id="busuanzi_value_site_uv"></span>
	</span>
</div>
  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>



  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-20},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
